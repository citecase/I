<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CiteCase - Supreme Court Research Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --brand-primary: #000000;
            --brand-accent: #3b82f6;
            --bg-main: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: #111827;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .search-result-card {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #f3f4f6;
        }
        .search-result-card:hover {
            border-color: #000;
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -10px rgba(0,0,0,0.05);
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #d1d5db; }

        .loader-progress {
            transition: width 0.6s cubic-bezier(0.65, 0, 0.35, 1);
        }

        .para-wrap {
            position: relative;
            padding-left: 1rem;
            border-left: 2px solid transparent;
            transition: all 0.2s;
        }
        .para-wrap:hover {
            border-left-color: #000;
            background: #fafafa;
        }
        .copy-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .para-wrap:hover .copy-btn, .search-result-card:hover .copy-btn {
            opacity: 1;
        }

        #toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #000;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        mark {
            background-color: #fef08a;
            color: #000;
            padding: 0 2px;
            border-radius: 2px;
        }

        #gate-screen {
            display: none;
            position: fixed;
            inset: 0;
            background: white;
            z-index: 9998;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
    </style>
</head>
<body class="bg-white">

    <!-- Splash Screen -->
    <div id="splash" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center p-6 transition-opacity duration-500">
        <div class="flex items-center gap-2 mb-8 animate-pulse">
            <span class="text-5xl font-black tracking-tighter">Cite</span>
            <span class="text-5xl font-black bg-black text-white px-3 py-1 rounded-2xl tracking-tighter">Case</span>
        </div>
        <div class="w-full max-w-xs h-1.5 bg-gray-100 rounded-full overflow-hidden mb-4">
            <div id="splash-bar" class="loader-progress h-full bg-black w-0"></div>
        </div>
        <div id="splash-status" class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.3em]">Initializing Archives</div>
    </div>

    <!-- Tally Form Gate -->
    <div id="gate-screen">
        <div class="w-full max-w-lg text-center mb-8">
            <div class="flex items-center justify-center gap-1 mb-6 opacity-20">
                <span class="text-2xl font-black tracking-tighter">Cite</span>
                <span class="text-2xl font-black bg-black text-white px-2 py-0.5 rounded-lg tracking-tighter">Case</span>
            </div>
            <h2 class="text-[10px] font-black uppercase tracking-[0.4em] text-gray-400 mb-2">Verification Required</h2>
            <p class="text-xs text-gray-400">Please complete the form below to access the database</p>
        </div>
        
        <div class="w-full max-w-2xl bg-gray-50 rounded-3xl p-2 md:p-6 border border-gray-100">
            <iframe data-tally-src="https://tally.so/embed/kd6QZJ?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1" loading="lazy" width="100%" height="300" frameborder="0" marginheight="0" marginwidth="0" title="CiteCase Lock"></iframe>
        </div>
    </div>

    <!-- Main App UI -->
    <div id="app" class="min-h-screen flex flex-col opacity-0 transition-opacity duration-700 pointer-events-none">
        <header id="hero" class="pt-32 pb-12 px-6 flex flex-col items-center transition-all duration-500">
            <div class="flex items-center gap-1 mb-16 cursor-pointer" onclick="window.scrollTo({top:0, behavior:'smooth'})">
                <span class="text-6xl md:text-7xl font-black tracking-tighter">Cite</span>
                <span class="text-6xl md:text-7xl font-black bg-black text-white px-4 py-1 rounded-[2rem] tracking-tighter">Case</span>
            </div>

            <div class="w-full max-w-3xl relative">
                <div class="relative group">
                    <input type="text" id="mainSearch" placeholder="Search case names, neutral citations or keywords..."
                           class="w-full pl-14 pr-6 py-6 bg-white border-2 border-gray-100 rounded-[2rem] text-xl outline-none focus:border-black focus:ring-8 focus:ring-gray-50 transition-all shadow-sm">
                    <i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-gray-300 group-focus-within:text-black text-xl transition-colors"></i>
                </div>

                <div class="flex flex-wrap justify-center items-center gap-6 mt-8 text-[10px] font-bold uppercase tracking-widest text-gray-400">
                    <label class="flex items-center gap-2 cursor-pointer hover:text-black transition-colors">
                        <input type="radio" name="searchLogic" value="and" checked class="accent-black w-4 h-4"> All Keywords
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:text-black transition-colors">
                        <input type="radio" name="searchLogic" value="exact" class="accent-black w-4 h-4"> Exact Match
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:text-black transition-colors">
                        <input type="radio" name="searchLogic" value="or" class="accent-black w-4 h-4"> Any Keyword
                    </label>
                </div>
            </div>

            <div id="stats-banner" class="mt-12 text-[10px] font-black text-gray-300 uppercase tracking-[0.3em]">
                Initializing database...
            </div>
        </header>

        <main id="results-view" class="hidden flex-1 pb-32">
            <div class="max-w-4xl mx-auto px-6">
                <div class="flex justify-between items-center mb-10 pb-4 border-b border-gray-50">
                    <div id="result-count" class="text-[10px] font-black text-gray-400 uppercase tracking-widest">0 results</div>
                    <div class="flex items-center gap-4">
                        <button onclick="copyCurrentResults()" class="text-[9px] font-black text-gray-400 hover:text-black uppercase tracking-widest flex items-center gap-2 transition-colors">
                            <i class="fas fa-copy"></i> Copy List
                        </button>
                    </div>
                </div>

                <div id="results-list" class="space-y-8"></div>
            </div>
        </main>

        <footer class="fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-gray-100 py-4 px-8 flex justify-between items-center z-50">
            <div class="flex items-center gap-8 text-[9px] font-bold text-gray-400 uppercase tracking-widest">
                <span>Â© 2026 CiteCase Premium</span>
                <a href="https://notebooklm.google.com/notebook/b451a149-6b7c-44da-96f0-bd946ea69b31" target="_blank" class="hover:text-black transition-colors flex items-center gap-1">
                    <i class="fas fa-robot"></i> NotebookLM AI
                </a>
            </div>
            <div id="search-speed" class="font-mono text-[9px] text-gray-300"></div>
        </footer>

        <div id="toast">Copied to Clipboard</div>
    </div>

    <!-- Tally Embed Script -->
    <script>
        var d=document,w="https://tally.so/widgets/embed.js",v=function(){"undefined"!=typeof Tally?Tally.loadEmbeds():d.querySelectorAll("iframe[data-tally-src]:not([src])").forEach((function(e){e.src=e.dataset.tallySrc}))};if("undefined"!=typeof Tally)v();else if(d.querySelector('script[src="'+w+'"]')==null){var s=d.createElement("script");s.src=w,s.onload=v,s.onerror=v,d.body.appendChild(s);}
    </script>

    <script>
        const SOURCES = [
            "https://raw.githubusercontent.com/citecase/I/refs/heads/main/2025INSC",
            "https://raw.githubusercontent.com/citecase/I/refs/heads/main/jan2026.md",
            "https://raw.githubusercontent.com/citecase/I/refs/heads/main/2024.md"
        ];

        let db = []; 
        let activeResults = [];

        const $ = (id) => document.getElementById(id);
        const notify = (msg) => {
            const t = $('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        };

        const copyText = (text) => {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            notify("Copied to Clipboard");
        };

        // Helper for element clicks
        window.handleCopy = (el) => {
            copyText(el.dataset.copyText);
        };

        window.addEventListener('message', (e) => {
            if (e.data && (typeof e.data === 'string' && e.data.includes('Tally.FormSubmitted')) || e.data.type === 'Tally.FormSubmitted') {
                revealApp();
            }
        });

        function parseWikiMarkdown(md) {
            const lines = md.split('\n');
            const entries = [];
            let current = null;
            const linkRegex = /\[(.*?)\]\((https?:\/\/.*?)\)/;

            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;
                
                const match = trimmed.match(linkRegex);
                if (match) {
                    if (current) entries.push(current);
                    let label = match[1].replace(/\*\*/g, '').replace(/#/g, '').trim();
                    let url = match[2];
                    
                    const inscRegex = /(202[4-6]\s+INSC\s+\d+)/i;
                    const inscMatch = label.match(inscRegex);
                    
                    let citation = "N/A", title = label;
                    if (inscMatch) {
                        citation = inscMatch[1];
                        title = label.replace(citation, '').replace(/^\s*-\s*/, '').replace(/\s*-\s*$/, '').trim();
                    } else {
                        const parts = label.split(' - ');
                        if (parts.length > 1) { 
                            title = parts[0].trim(); 
                            citation = parts.slice(1).join(' - ').trim(); 
                        }
                    }

                    current = { 
                        id: Math.random().toString(36).substr(2, 9), 
                        title, 
                        citation, 
                        link: url, 
                        paragraphs: [] 
                    };
                } else if (current) {
                    if (!/^[-*_=]{3,}$/.test(trimmed)) current.paragraphs.push(trimmed);
                }
            });
            if (current) entries.push(current);
            return entries;
        }

        async function bootstrap() {
            const splashBar = $('splash-bar');
            const splashText = $('splash-status');

            try {
                const cb = `?v=${Date.now()}`;
                splashText.innerText = "Indexing Judgments...";
                splashBar.style.width = "50%";
                
                let combinedData = [];
                for (const url of SOURCES) {
                    try {
                        const r = await fetch(url + cb);
                        if(r.ok) combinedData.push(...parseWikiMarkdown(await r.text()));
                    } catch(e) {}
                }
                db = combinedData;

                splashBar.style.width = "100%";
                setTimeout(showGate, 600);
            } catch (err) {
                splashText.innerText = "Sync Failed. Retrying...";
                setTimeout(() => location.reload(), 3000);
            }
        }

        function showGate() {
            $('splash').classList.add('opacity-0');
            setTimeout(() => {
                $('splash').style.display = 'none';
                $('gate-screen').style.display = 'flex';
            }, 500);
        }

        function revealApp() {
            $('gate-screen').style.opacity = '0';
            setTimeout(() => {
                $('gate-screen').style.display = 'none';
                $('app').classList.remove('pointer-events-none');
                $('app').style.opacity = '1';
                updateBanner();
                $('mainSearch').focus();
            }, 500);
        }

        function performSearch() {
            const query = $('mainSearch').value.toLowerCase().trim();
            const logic = document.querySelector('input[name="searchLogic"]:checked').value;
            const startTime = performance.now();

            if (query.length < 3) {
                $('hero').style.paddingTop = "8rem";
                $('results-view').classList.add('hidden');
                return;
            }

            $('hero').style.paddingTop = "2rem";
            $('results-view').classList.remove('hidden');

            const terms = query.split(/\s+/).filter(t => t.length > 0);

            let results = db.map(item => {
                const text = `${item.title} ${item.citation || ''} ${(item.paragraphs || []).join(' ')}`.toLowerCase();
                let score = 0;

                if (logic === 'exact') {
                    if (text.includes(query)) score = 100;
                } else if (logic === 'or') {
                    terms.forEach(t => { if(text.includes(t)) score++; });
                } else { 
                    const allFound = terms.every(t => text.includes(t));
                    if (allFound) score = terms.length;
                }

                return { ...item, score };
            }).filter(i => i.score > 0);

            results.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                const getYear = (c) => parseInt(c.match(/\b202[4-6]\b/)?.[0] || 0);
                return getYear(b.citation) - getYear(a.citation);
            });

            activeResults = results;
            renderResults(results, query);
            
            $('result-count').innerText = `${results.length} Judgments Found`;
            $('search-speed').innerText = `${(performance.now() - startTime).toFixed(1)}ms execution`;
        }

        function renderResults(data, query = "") {
            const container = $('results-list');
            if (!data.length) {
                container.innerHTML = `<div class="py-20 text-center text-gray-300 font-bold uppercase tracking-widest text-[10px]">No records found</div>`;
                return;
            }

            container.innerHTML = data.map(item => {
                // Safely handle content for dataset
                const safeTitle = item.title.replace(/"/g, '&quot;');
                
                return `
                <div class="search-result-card bg-white p-8 rounded-2xl border border-gray-100">
                    <div class="flex flex-col md:flex-row justify-between gap-6 mb-6">
                        <div class="flex-1">
                            <div class="text-[8px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2">Supreme Court Judgment</div>
                            <h3 class="text-2xl font-black text-black leading-tight mb-2 tracking-tighter">${highlight(item.title, query)}</h3>
                            ${item.citation && item.citation !== 'N/A' ? `<div class="font-mono text-[10px] text-gray-400 font-bold">${highlight(item.citation, query)}</div>` : ''}
                        </div>
                        <div class="flex flex-wrap items-center gap-2 shrink-0">
                            <button onclick="handleCopy(this)" data-copy-text="${safeTitle}" class="copy-btn w-10 h-10 flex items-center justify-center bg-gray-50 hover:bg-black hover:text-white text-gray-300 rounded-xl transition-all" title="Copy Heading">
                                <i class="fas fa-copy"></i>
                            </button>
                            <a href="${item.link}" target="_blank" class="bg-black text-white px-6 py-2.5 rounded-xl text-[10px] font-black tracking-widest hover:bg-gray-800 transition-all">
                                VIEW FULL PDF
                            </a>
                        </div>
                    </div>
                    <div class="space-y-4 pt-6 border-t border-gray-50">
                        ${(item.paragraphs || []).map(p => {
                            const safePara = p.replace(/"/g, '&quot;');
                            return `
                            <div class="para-wrap group">
                                <p class="text-[15px] text-gray-600 leading-relaxed">${highlight(p, query)}</p>
                                <button onclick="handleCopy(this)" data-copy-text="${safePara}" class="copy-btn absolute top-0 -right-2 p-2 text-[9px] text-gray-300 hover:text-black">
                                    <i class="fas fa-quote-left"></i>
                                </button>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                `;
            }).join('');
        }

        function highlight(text, query) {
            if (!query || query.length < 3) return text;
            const terms = query.split(/\s+/).filter(t => t.length > 2);
            let result = text;
            terms.forEach(t => {
                // Escape special regex chars
                const pattern = t.replace(/[.*+?^${}()|[\]\\]/g, '$&');
                const regex = new RegExp(`(${pattern})`, 'gi');
                result = result.replace(regex, '<mark>$1</mark>');
            });
            return result;
        }

        function updateBanner() {
            $('stats-banner').innerText = `${db.length.toLocaleString()} JUDGMENTS INDEXED`;
        }

        function copyCurrentResults() {
            if (!activeResults.length) return;
            const text = activeResults.map(r => `${r.title} | ${r.citation || ''}\n${(r.paragraphs || []).join('\n')}`).join('\n\n---\n\n');
            copyText(text);
        }

        $('mainSearch').addEventListener('input', performSearch);
        document.querySelectorAll('input[name="searchLogic"]').forEach(el => el.addEventListener('change', performSearch));

        window.onload = bootstrap;
    </script>
</body>
</html>
