<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CiteCase Archives | Deep PDF Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #ffffff; 
        }
        
        .logo-font {
            font-family: 'Lora', serif;
        }

        .legal-text {
            font-family: 'Lora', serif;
        }
        
        #viewer-container {
            height: calc(100vh - 16rem);
            overflow-y: auto;
            background-color: #ffffff;
            display: none;
        }

        .pdf-page-container {
            margin: 20px auto;
            background: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 95%;
            border: 1px solid #f1f5f9;
        }

        .pdf-page-canvas {
            display: block;
            max-width: 100%;
        }

        .page-skeleton {
            position: absolute;
            inset: 0;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #cbd5e1;
        }

        .loading-overlay {
            background: #ffffff;
            z-index: 100;
        }

        /* Portal Animation States */
        #portal-container {
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .portal-landing {
            padding-top: 25vh;
        }

        .portal-active {
            padding-top: 2rem;
        }

        /* Full Page Results Overlay */
        #search-results-overlay {
            display: none;
            z-index: 60;
            height: calc(100vh - 18rem);
            margin-top: 1.5rem;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        select {
            @apply appearance-none bg-white border border-slate-200 font-bold uppercase tracking-widest text-[10px] py-2.5 px-4 rounded-xl cursor-pointer hover:bg-slate-50 transition-colors focus:ring-2 focus:ring-slate-900 focus:outline-none shadow-sm;
        }

        @media (max-width: 768px) {
            .portal-landing { padding-top: 15vh; }
            #search-results-overlay {
                position: fixed;
                left: 0;
                right: 0;
                top: 15rem;
                width: 100%;
                height: calc(100vh - 15rem);
                margin-top: 0;
                border-radius: 0;
            }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Help Modal (Pop-up) -->
    <div id="help-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/20 backdrop-blur-sm" onclick="hideHelp()">
        <div class="bg-white p-8 md:p-10 rounded-[2.5rem] shadow-2xl max-w-lg mx-4 border border-slate-100 animate-in fade-in zoom-in duration-300" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-black mb-4 logo-font tracking-tight">Guide to CiteCase</h3>
            <div class="text-slate-600 leading-relaxed legal-text italic mb-8 space-y-4">
                <p>This is a web-app (beta mode) which will help our subscribers to search through our Supreme Court Digests since 2024.</p>
                <p>You can do case name search, neutral citation search and keyword, law name and provision wise search using this. It should lead you to the page in our Digest which discusses something about what you searched.</p>
            </div>
            <button onclick="hideHelp()" class="w-full py-4 bg-black text-white rounded-2xl font-bold uppercase tracking-[0.2em] text-[10px] hover:bg-slate-800 transition-colors shadow-lg shadow-black/10">Got it</button>
        </div>
    </div>

    <!-- Indexing Overlay -->
    <div id="loading" class="loading-overlay absolute inset-0 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-slate-900 border-t-transparent rounded-full animate-spin mb-6"></div>
        <p class="text-slate-900 font-extrabold text-xl logo-font" id="loading-text">Indexing CiteCase Archives...</p>
        <p id="loading-progress" class="text-[11px] text-slate-400 mt-2 font-mono uppercase tracking-widest font-bold">Building Paragraph Index...</p>
    </div>

    <!-- Centered Header & Search Portal Wrapper -->
    <div id="portal-container" class="portal-landing w-full flex flex-col items-center bg-white z-50 transition-all duration-500">
        
        <!-- Centralized Branding & Navigation -->
        <div class="w-full max-w-5xl px-4 flex flex-col items-center mb-6 relative">
            
            <!-- Logo Section (Joined CiteCase - No Space) -->
            <div class="mb-6">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-black tracking-tighter flex items-center cursor-default logo-font overflow-hidden rounded-2xl border border-slate-200 shadow-sm">
                    <span class="text-black bg-white px-4 md:px-6 py-2">Cite</span><span class="text-white bg-black px-4 md:px-6 py-2">Case</span>
                </h1>
            </div>

            <!-- Digest Selector -->
            <div class="mb-6 z-10">
                <select id="doc-selector" title="Select Archive">
                    <option value="2026-01" selected>Supreme Court Monthly Digest - January 2026</option>
                    <option value="2025">Supreme Court Yearly Digest 2025</option>
                    <option value="2024">Supreme Court Yearly Digest 2024</option>
                </select>
            </div>

            <!-- Zoom Controls (Visible when viewer is active) -->
            <div id="zoom-controls" class="hidden absolute right-4 top-0 items-center gap-1">
                <button id="zoom-out" class="p-2.5 hover:bg-slate-50 rounded-xl text-slate-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                <button id="zoom-in" class="p-2.5 hover:bg-slate-50 rounded-xl text-slate-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
            </div>
        </div>

        <!-- Search Box Container -->
        <div class="w-full max-w-4xl relative px-4 pb-4 flex flex-col items-center">
            <form id="search-form" onsubmit="event.preventDefault(); handleSearch(); return false;" class="w-full relative">
                <input 
                    type="search" 
                    id="search-input" 
                    placeholder="Search Through Our Supreme Court Digests" 
                    class="w-full pl-16 pr-16 py-6 bg-slate-50 border border-slate-200 rounded-[3rem] text-xl font-medium focus:ring-8 focus:ring-slate-900/5 focus:bg-white focus:border-slate-900 transition-all shadow-inner text-center"
                    autocomplete="off"
                >
                <div class="absolute left-10 top-1/2 -translate-y-1/2 text-slate-900">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                </div>
                <button type="button" onclick="clearSearch()" class="absolute right-10 top-1/2 -translate-y-1/2 text-slate-300 hover:text-slate-900 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </form>

            <!-- How to Use? button -->
            <button onclick="showHelp()" class="mt-4 text-[10px] font-bold text-slate-400 hover:text-slate-900 transition-colors uppercase tracking-[0.2em] border-b border-transparent hover:border-slate-900 pb-0.5">How to Use?</button>

            <!-- Full Page Results Overlay -->
            <div id="search-results-overlay" class="w-full bg-white rounded-[2.5rem] shadow-2xl border border-slate-200 overflow-hidden flex flex-col">
                <div class="p-5 bg-white border-b border-slate-100 flex flex-wrap gap-6 items-center justify-center">
                    <div class="flex gap-6">
                        <div class="flex flex-col items-center">
                            <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1.5">Search Mode</label>
                            <select id="logic-selector" class="text-center bg-transparent border-none shadow-none py-0 px-2 font-black text-slate-900">
                                <option value="phrase" selected>Exact Sequence</option>
                                <option value="and">All Words (AND)</option>
                                <option value="or">Any Word (OR)</option>
                            </select>
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1.5">Context Depth</label>
                            <select id="context-selector" class="text-center bg-transparent border-none shadow-none py-0 px-2 font-black text-slate-900">
                                <option value="-1" selected>Para Match (Focused)</option>
                                <option value="-2">Full Page</option>
                                <option value="400">Detailed Buffer</option>
                                <option value="150">Standard Buffer</option>
                            </select>
                        </div>
                    </div>
                    <div id="results-count-badge" class="text-[11px] font-bold text-slate-900 uppercase px-4 py-2 bg-slate-50 rounded-full border border-slate-200"></div>
                </div>
                <div id="results-list" class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-white space-y-8"></div>
                <div class="p-4 border-t border-slate-50 flex justify-center bg-white">
                    <button onclick="hideResults()" class="text-[11px] font-bold text-slate-400 uppercase tracking-widest hover:text-slate-900 transition-colors py-2">Return to Search</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    <main class="flex-1 flex flex-col overflow-hidden relative bg-white">
        <div id="viewer-container" class="flex-1 custom-scrollbar scroll-smooth relative z-10">
            <div id="pdf-viewer" class="py-6 md:py-10 bg-white"></div>
        </div>
    </main>

    <script>
        const pdfUrls = {
            "2026-01": "https://raw.githubusercontent.com/citecase/2026INSCJAN/main/Supreme%20Court%20Monthly%20Digest%20-%20January%202026-2.pdf",
            "2025": "https://raw.githubusercontent.com/citecase/search/main/Supreme-Court-Yearly-Digest-2025.pdf",
            "2024": "https://raw.githubusercontent.com/citecase/search/main/Yearly-Digest-2024_unlocked.pdf"
        };
        
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let scale = window.innerWidth < 768 ? 0.85 : 1.35;
        let pagesData = []; 
        let currentRenderSessionId = 0; 
        let pageObserver = null;

        function showHelp() { document.getElementById('help-modal').style.display = 'flex'; }
        function hideHelp() { document.getElementById('help-modal').style.display = 'none'; }

        function setupObserver() {
            if (pageObserver) pageObserver.disconnect();
            pageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const pageNum = parseInt(entry.target.dataset.pageNum);
                        renderVisiblePage(pageNum, entry.target);
                    }
                });
            }, { root: document.getElementById('viewer-container'), rootMargin: '800px', threshold: 0.1 });
        }

        async function init(docId = "2026-01") {
            const thisSessionId = ++currentRenderSessionId;
            const rawUrl = pdfUrls[docId];
            const selector = document.getElementById('doc-selector');
            const docTitle = selector.options[selector.selectedIndex].text;
            
            document.getElementById('pdf-viewer').innerHTML = '';
            document.getElementById('viewer-container').style.display = 'none';
            document.getElementById('zoom-controls').classList.replace('flex', 'hidden');
            
            const loadingOverlay = document.getElementById('loading');
            loadingOverlay.style.display = 'flex';
            document.getElementById('loading-text').textContent = `Syncing ${docTitle}`;
            pagesData = [];

            try {
                const response = await fetch(rawUrl);
                const data = await response.arrayBuffer();
                if (thisSessionId !== currentRenderSessionId) return;

                pdfDoc = await pdfjsLib.getDocument({ data, cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/', cMapPacked: true }).promise;
                const totalPages = pdfDoc.numPages;
                const viewer = document.getElementById('pdf-viewer');

                setupObserver();

                for (let i = 1; i <= totalPages; i++) {
                    if (thisSessionId !== currentRenderSessionId) return;
                    const page = await pdfDoc.getPage(i);
                    const textContent = await page.getTextContent();
                    const fullText = textContent.items.map(item => item.str).join(' ');
                    
                    let paragraphs = [];
                    let currentPara = "";
                    
                    textContent.items.forEach(item => {
                        const text = item.str.trim();
                        currentPara += item.str + " ";
                        if ((text.endsWith('.') || text.endsWith(':')) && currentPara.length > 20) {
                            paragraphs.push(currentPara.trim());
                            currentPara = "";
                        }
                    });
                    if (currentPara.trim()) paragraphs.push(currentPara.trim());

                    pagesData.push({ 
                        pageNum: i, 
                        text: fullText, 
                        paragraphs: paragraphs 
                    });
                    
                    const viewport = page.getViewport({ scale });
                    const container = document.createElement('div');
                    container.className = 'pdf-page-container';
                    container.style.width = `${viewport.width}px`;
                    container.style.height = `${viewport.height}px`;
                    container.dataset.pageNum = i;
                    container.id = `page-container-${i}`;
                    container.innerHTML = `<div class="page-skeleton font-mono text-[10px] font-bold tracking-tighter opacity-50 uppercase">Rendering Page ${i}</div>`;
                    
                    viewer.appendChild(container);
                    pageObserver.observe(container);

                    if (i % 60 === 0) {
                        document.getElementById('loading-progress').textContent = `Indexed ${i} / ${totalPages}`;
                    }
                }
                loadingOverlay.style.display = 'none';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function renderVisiblePage(pageNum, container) {
            if (container.dataset.rendered === "true") return;
            container.dataset.rendered = "true";
            try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale });
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page-canvas';
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                const skeleton = container.querySelector('.page-skeleton');
                if (skeleton) skeleton.remove();
                container.appendChild(canvas);
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
            } catch (e) { container.dataset.rendered = "false"; }
        }

        function handleSearch() {
            const input = document.getElementById('search-input');
            const rawQuery = input.value.trim();
            const resultsOverlay = document.getElementById('search-results-overlay');
            const portal = document.getElementById('portal-container');
            const list = document.getElementById('results-list');
            const logic = document.getElementById('logic-selector').value;
            const contextRadius = parseInt(document.getElementById('context-selector').value);
            
            if (!rawQuery || rawQuery.length < 2) {
                resultsOverlay.style.display = 'none';
                portal.className = 'portal-landing w-full flex flex-col items-center bg-white transition-all';
                return;
            }

            portal.className = 'portal-active w-full flex flex-col items-center bg-white z-50 transition-all';

            const normalizedQuery = rawQuery.toLowerCase().replace(/\s+/g, ' ');
            const queryTerms = normalizedQuery.match(/"[^"]+"|\S+/g).map(t => t.replace(/"/g, ''));
            const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            
            const termRegexes = queryTerms.map(term => new RegExp('\\b' + escapeRegExp(term) + '\\b', 'i'));
            const phraseRegex = new RegExp('\\b' + escapeRegExp(normalizedQuery).replace(/\s+/g, '\\s+') + '\\b', 'i');

            const results = [];

            pagesData.forEach(page => {
                page.paragraphs.forEach((para, paraIdx) => {
                    const paraLower = para.toLowerCase().replace(/\s+/g, ' ');
                    let matchFound = false;
                    let isContinuous = false;
                    let firstMatchPos = -1;

                    if (logic === 'phrase') {
                        const match = paraLower.match(phraseRegex);
                        if (match) { 
                            matchFound = true; 
                            isContinuous = true; 
                            firstMatchPos = match.index; 
                        }
                    } else if (logic === 'and') {
                        if (termRegexes.every(re => re.test(paraLower))) {
                            matchFound = true;
                            const phraseMatch = paraLower.match(phraseRegex);
                            isContinuous = !!phraseMatch;
                            const firstTermMatch = paraLower.match(termRegexes[0]);
                            firstMatchPos = firstTermMatch ? firstTermMatch.index : 0;
                        }
                    } else if (logic === 'or') {
                        const matches = termRegexes.map(re => paraLower.match(re)).filter(m => m !== null);
                        if (matches.length > 0) {
                            matchFound = true;
                            isContinuous = !!paraLower.match(phraseRegex);
                            firstMatchPos = matches[0].index;
                        }
                    }

                    if (matchFound) {
                        let snippet = "";
                        if (contextRadius === -2) {
                            // Full page context
                            snippet = page.text;
                        } else if (contextRadius === -1) {
                            // Focused Paragraph: Starts from the "line" (offset slightly before match)
                            const startIdx = Math.max(0, firstMatchPos - 40); // 40 chars leading context
                            snippet = (startIdx > 0 ? "... " : "") + para.substring(startIdx);
                        } else {
                            // Buffer based context
                            const startIdx = Math.max(0, firstMatchPos - contextRadius);
                            const endIdx = Math.min(para.length, firstMatchPos + contextRadius);
                            snippet = (startIdx > 0 ? "... " : "") + para.substring(startIdx, endIdx) + (endIdx < para.length ? " ..." : "");
                        }

                        let highlightedSnippet = snippet;
                        termRegexes.forEach(re => {
                            const globalRe = new RegExp('\\b(' + re.source.slice(2, -2) + ')\\b', 'gi');
                            highlightedSnippet = highlightedSnippet.replace(globalRe, '<span class="bg-yellow-200 font-bold text-slate-900 px-0.5 rounded">$1</span>');
                        });

                        results.push({ 
                            pageNum: page.pageNum, 
                            snippet: highlightedSnippet, 
                            isContinuous, 
                            paraIdx 
                        });
                    }
                });
            });

            results.sort((a, b) => b.isContinuous - a.isContinuous);
            document.getElementById('results-count-badge').textContent = `${results.length} results found`;
            resultsOverlay.style.display = 'flex';
            list.innerHTML = results.length ? '' : `<div class="p-12 text-center text-slate-400 text-sm italic legal-text">No matches found.</div>`;

            results.forEach(res => {
                const div = document.createElement('div');
                div.className = `p-8 border-b border-slate-100 cursor-pointer bg-white transition-all active:bg-slate-50`;
                div.onclick = () => scrollToPage(res.pageNum);
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-4">
                            <span class="text-[12px] font-black text-slate-900 border border-slate-900 px-3 py-1 rounded-lg tracking-widest uppercase">Page ${res.pageNum}</span>
                            ${res.isContinuous ? '<span class="text-[11px] font-bold text-slate-500 uppercase tracking-widest">Exact Match</span>' : ''}
                        </div>
                        <svg class="text-slate-300" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
                    </div>
                    <p class="text-[14px] text-slate-700 leading-relaxed whitespace-pre-line legal-text italic">"${res.snippet}"</p>
                `;
                list.appendChild(div);
            });
        }

        function scrollToPage(num) {
            const viewer = document.getElementById('viewer-container');
            viewer.style.display = 'block';
            document.getElementById('zoom-controls').classList.replace('hidden', 'flex');
            
            const el = document.getElementById(`page-container-${num}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                el.classList.add('ring-8', 'ring-slate-900', 'ring-opacity-5');
                setTimeout(() => el.classList.remove('ring-8', 'ring-slate-900', 'ring-opacity-5'), 2500);
                hideResults();
            }
        }

        function clearSearch() { 
            document.getElementById('search-input').value = ''; 
            document.getElementById('search-results-overlay').style.display = 'none'; 
            document.getElementById('viewer-container').style.display = 'none';
            document.getElementById('zoom-controls').classList.replace('hidden', 'flex');
            document.getElementById('portal-container').className = 'portal-landing w-full flex flex-col items-center bg-white transition-all';
        }

        function hideResults() { 
            document.getElementById('search-results-overlay').style.display = 'none'; 
            if (document.getElementById('search-input').value === "") {
                document.getElementById('portal-container').className = 'portal-landing w-full flex flex-col items-center bg-white transition-all';
            }
        }

        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        if (zoomInBtn) zoomInBtn.onclick = () => { scale += 0.2; updateZoom(); };
        if (zoomOutBtn) zoomOutBtn.onclick = () => { if (scale > 0.5) scale -= 0.2; updateZoom(); };

        async function updateZoom() {
            if (!pdfDoc) return;
            init(document.getElementById('doc-selector').value);
        }

        function debounce(func, timeout = 300) {
            let timer;
            return (...args) => { clearTimeout(timer); timer = setTimeout(() => { func.apply(this, args); }, timeout); };
        }

        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('search-input');
            input.addEventListener('input', debounce(handleSearch, 450));
            document.getElementById('doc-selector').addEventListener('change', (e) => init(e.target.value));
            document.getElementById('logic-selector').addEventListener('change', () => handleSearch());
            document.getElementById('context-selector').addEventListener('change', () => handleSearch());
            init("2026-01");
        });
    </script>
</body>
</html>
